# /*************************************************************************************************
# * Copyright 2023-2024 Theai, Inc. dba Inworld AI
# *
# * Use of this source code is governed by the Inworld.ai Software Development Kit License Agreement
# * that can be found in the LICENSE.md file or at https://www.inworld.ai/sdk-license
# *************************************************************************************************/

name: build-win

on:
  workflow_call:

jobs:
  build-win:
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v2
    - name: git-update-dependecies
      run: git submodule update --init --recursive
      shell: bash

    - name: cppcheck-install
      run: |
        choco install cppcheck --confirm
        exitCode=$?
        exePath="/c/Program Files/Cppcheck/cppcheck.exe"
        if [[ $exitCode -eq 3010 || $exitCode -eq 0 ]]; then
          if [[ -f "$exePath" ]]; then
              exit 0
          else
              echo "Couldn't find CppCheck exe file by /c/Program Files/Cppcheck/cppcheck.exe path"
              exit 1
          fi
        fi
      shell: bash

    - name: gen
      run: |
        ./win-gen.bat > GenLog.txt
        cat GenLog.txt
        if grep -q "Configuring incomplete" GenLog.txt; then
          exit 1
        fi
        exit 0
      shell: bash

    - name: cppcheck-run
      run: |
        ./win-cppcheck.bat > CppCheckLog.txt
        cat CppCheckLog.txt
        if grep -q "cppcheck fail:" CppCheckLog.txt; then
          echo "CppCheck fail"
          exit 1
        fi
        exit 0
      shell: bash

    - name: build-win
      run: |
        ./win-build.bat > BuildLog.txt
        cat BuildLog.txt
        if ! grep -q "inworld-ndk.vcxproj ->" BuildLog.txt; then
          exit 1
        else
          echo "inworld-ndk built successfully"
        fi
        if ! grep -q "inworld-ndk-app.vcxproj ->" BuildLog.txt; then
          exit 1
        else
          echo "inworld-ndk-app built successfully"
        fi
        if ! grep -q "inworld-ndk-unit.vcxproj ->" BuildLog.txt; then
          exit 1
        else
          echo "inworld-ndk-unit built successfully"
        fi
        if grep -q "[  FAILED  ]" BuildLog.txt; then
          exit 1
        fi
        exit 0
      shell: bash

    - name: clear-cmake-cache
      run: rm -f build/CMakeCache.txt
      shell: bash

    - name: gen-shared
      run: |
        ./win-gen-shared.bat > GenLog.txt
        cat GenLog.txt
        if grep -q "Configuring incomplete" GenLog.txt; then
          exit 1
        fi
        exit 0
      shell: bash

    - name: build-win-shared
      run: |
        ./win-build.bat > BuildLog.txt
        cat BuildLog.txt
        if ! grep -q "inworld-ndk.vcxproj ->" BuildLog.txt; then
          exit 1
        else
          echo "inworld-ndk built successfully"
        fi
        if ! grep -q "inworld-ndk-app.vcxproj ->" BuildLog.txt; then
          exit 1
        else
          echo "inworld-ndk-app built successfully"
        fi
        if ! grep -q "inworld-ndk-unit.vcxproj ->" BuildLog.txt; then
          exit 1
        else
          echo "inworld-ndk-unit built successfully"
        fi
        if grep -q "[  FAILED  ]" BuildLog.txt; then
          exit 1
        fi
        exit 0
      shell: bash

    - uses: actions/cache@v3
      with:
        path: build/Package
        key: ndk-cache-win64-${{ github.sha }}